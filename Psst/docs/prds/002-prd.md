# PRD: iOS AI Scaffolding

**Feature**: iOS AI Infrastructure Foundation

**Version**: 1.0

**Status**: Draft

**Agent**: Caleb

**Target Release**: Phase 1 - Foundation

**Links**: 
- [PR Brief](../ai-briefs.md#pr-002-ios-ai-scaffolding)
- [TODO](../todos/pr-002-todo.md)
- [AI Product Vision](../AI-PRODUCT-VISION.md)
- [Architecture](../architecture.md)

---

## 1. Summary

Create the iOS-side AI infrastructure layer including `AIService`, data models (`AIMessage`, `AIConversation`, `AIResponse`), and UI skeleton (`AIAssistantView`) with mock data support. This establishes the foundation for all AI features while enabling frontend development independent of backend readiness.

---

## 2. Problem & Goals

**Problem:** Before implementing user-facing AI features (chat, contextual actions, voice), we need iOS-side infrastructure to handle AI interactions, data models, and UI patterns. Without this scaffolding, future AI features would need to repeatedly solve the same foundational problems (how to call Cloud Functions, structure AI data, display responses).

**Why Now:** This is Phase 1 Foundation work that enables parallel development. Frontend AI features (PR #004, #006, #010) depend on this infrastructure. Building it now allows iOS and backend development to proceed independently.

**Goals:**
- [ ] G1 â€” Create service layer (`AIService`) for Cloud Function communication with async/await patterns
- [ ] G2 â€” Define Swift data models for AI messages, conversations, and responses with Codable conformance
- [ ] G3 â€” Build skeleton UI (`AIAssistantView`) that can display mock AI interactions
- [ ] G4 â€” Establish mock data system for AI development and testing without backend dependency

---

## 3. Non-Goals / Out of Scope

Call out what's intentionally excluded:

- [ ] Not implementing actual AI functionality (no OpenAI, no embeddings) - that's PR #001 (backend)
- [ ] Not building complete AI chat UI - this is skeleton/placeholder only
- [ ] Not integrating with real Cloud Functions - using mock responses
- [ ] Not implementing contextual AI actions (long-press menu) - that's PR #006
- [ ] Not adding voice interface - that's PR #010
- [ ] Not storing AI conversations in Firestore - in-memory only for now

---

## 4. Success Metrics

**User-visible:**
- AI Assistant view renders without errors (even with mock data)
- Developers can import `AIService` and call methods
- 0 console errors during AI view navigation

**System:**
- AIService methods compile and run with proper type safety
- Models conform to Codable and encode/decode correctly
- Mock data provides realistic AI conversation scenarios
- Async operations complete without blocking main thread (<50ms UI response)

**Quality:**
- 0 blocking bugs
- All acceptance gates pass
- SwiftUI previews render successfully
- Crash-free rate 100% (no runtime errors)

---

## 5. Users & Stories

**Primary User:** iOS Developers (building future AI features)

- As an iOS developer, I want a ready-to-use `AIService` so that I can add AI features without reinventing infrastructure
- As an iOS developer, I want Swift data models for AI so that I have type-safe structures for AI messages and responses
- As an iOS developer, I want mock AI data so that I can build and test UI before the backend is ready
- As a product engineer, I want a skeleton AI view so that I can see where AI features will live in the app
- As a future PR implementer, I want async/await patterns established so that I follow consistent patterns for AI operations

---

## 6. Experience Specification (UX)

**Entry Points:**
- Navigation from `ChatListView` (floating AI button) - **placeholder only for now**
- AI Assistant appears in navigation (optional tab or modal)

**Visual Behavior:**
- Simple chat-like interface with mock AI bubbles
- User messages appear in blue (right-aligned)
- AI responses appear in gray (left-aligned)
- Basic text input field (placeholder, not functional yet)
- Empty state: "AI Assistant (Coming Soon)"

**Loading/Disabled/Error States:**
- Loading: Animated typing indicator "..." (reuse `TypingIndicatorView` if applicable)
- Error: Shows "AI service unavailable" message
- Empty: Shows placeholder message explaining this is under development

**Performance:**
- View loads instantly (<100ms)
- No blocking operations on main thread
- SwiftUI previews render without delay

---

## 7. Functional Requirements (Must/Should)

**MUST:**
- AIService provides async methods for future Cloud Function calls
- Models (AIMessage, AIConversation, AIResponse) conform to Codable
- AIAssistantView displays mock conversation data
- Mock data includes 3-5 sample AI exchanges
- All code follows MVVM pattern (Service â†’ ViewModel â†’ View)
- Async operations use Swift async/await (not callbacks)
- No hardcoded strings (use constants)

**SHOULD:**
- AIService methods have clear documentation comments
- Mock data covers different AI response types (short answer, long answer, list format)
- View skeleton includes space for future features (voice button, quick actions)
- Error handling scaffolding in place (even if not fully functional)

**Acceptance Gates:**
- [Gate] AIService compiles and can be instantiated without errors
- [Gate] Mock AI conversation displays in AIAssistantView with proper formatting
- [Gate] SwiftUI preview works for AIAssistantView
- [Gate] Models encode to JSON and decode back without data loss
- [Gate] No console warnings when navigating to AI view

---

## 8. Data Model

### AIMessage

Represents a single message in an AI conversation (user or AI).

```swift
import Foundation

struct AIMessage: Identifiable, Codable, Equatable {
    let id: String
    let text: String
    let isFromUser: Bool
    let timestamp: Date
    let status: AIMessageStatus // .sending, .delivered, .failed
    
    enum AIMessageStatus: String, Codable {
        case sending
        case delivered
        case failed
    }
}
```

**Validation Rules:**
- `text` cannot be empty
- `timestamp` defaults to current time if not provided
- `status` defaults to `.delivered` for mock data

---

### AIConversation

Represents an AI chat session with message history.

```swift
import Foundation

struct AIConversation: Identifiable, Codable, Equatable {
    let id: String
    let messages: [AIMessage]
    let createdAt: Date
    let updatedAt: Date
    
    var lastMessage: AIMessage? {
        messages.last
    }
}
```

**Validation Rules:**
- `messages` array can be empty (new conversation)
- `updatedAt` should be >= `createdAt`
- `id` must be unique

---

### AIResponse

Represents a response from the AI backend (future Cloud Function).

```swift
import Foundation

struct AIResponse: Codable, Equatable {
    let messageId: String
    let text: String
    let timestamp: Date
    let metadata: AIResponseMetadata?
    
    struct AIResponseMetadata: Codable, Equatable {
        let modelUsed: String? // e.g., "gpt-4"
        let tokensUsed: Int?
        let responseTime: TimeInterval? // in seconds
    }
}
```

**Validation Rules:**
- `text` is the AI's response content
- `metadata` is optional (may not be present in all responses)
- All fields conform to Codable for easy JSON serialization

---

## 9. API / Service Contracts

### AIService.swift

Handles communication with AI backend (Cloud Functions).

```swift
import Foundation
import FirebaseAuth
import FirebaseFunctions

@MainActor
class AIService: ObservableObject {
    private let functions = Functions.functions()
    
    /// Sends a message to the AI assistant and returns the response
    /// - Parameters:
    ///   - message: The user's message text
    ///   - conversationId: Optional conversation ID for context
    /// - Returns: AIResponse with AI's reply
    /// - Throws: AIError if request fails
    func sendMessage(message: String, conversationId: String?) async throws -> AIResponse
    
    /// Creates a new AI conversation
    /// - Returns: New AIConversation instance with unique ID
    func createConversation() -> AIConversation
    
    /// Loads mock AI response for development (temporary)
    /// - Parameter message: User's message
    /// - Returns: Mock AIResponse
    func getMockResponse(for message: String) async -> AIResponse
}
```

**Error Handling:**

```swift
enum AIError: LocalizedError {
    case notAuthenticated
    case networkError(Error)
    case invalidResponse
    case rateLimitExceeded
    case serviceUnavailable
    
    var errorDescription: String? {
        switch self {
        case .notAuthenticated:
            return "You must be logged in to use AI features"
        case .networkError(let error):
            return "Network error: \(error.localizedDescription)"
        case .invalidResponse:
            return "Received invalid response from AI service"
        case .rateLimitExceeded:
            return "Too many requests. Please wait a moment."
        case .serviceUnavailable:
            return "AI service is currently unavailable"
        }
    }
}
```

**Pre-conditions:**
- User must be authenticated (Firebase Auth)
- `message` parameter cannot be empty

**Post-conditions:**
- Returns valid `AIResponse` with non-empty text
- On failure, throws descriptive `AIError`

---

## 10. UI Components to Create/Modify

**New Files to Create:**

**Models:**
- `Models/AIMessage.swift` â€” AI message data model
- `Models/AIConversation.swift` â€” AI conversation model
- `Models/AIResponse.swift` â€” AI response model

**Services:**
- `Services/AIService.swift` â€” Cloud Function communication + mock data

**ViewModels:**
- `ViewModels/AIAssistantViewModel.swift` â€” Manages AI chat state, sends messages, handles responses

**Views:**
- `Views/AI/AIAssistantView.swift` â€” Main AI chat interface (skeleton)
- `Views/AI/AIMessageRow.swift` â€” Individual AI message bubble
- `Views/Components/AILoadingIndicator.swift` â€” "AI is thinking..." animated indicator

**Utilities:**
- `Utilities/MockAIData.swift` â€” Mock conversation data for development

---

## 11. Integration Points

**Firebase:**
- Firebase Functions (future) - methods stubbed out but not called yet
- Firebase Auth - verify user authentication before AI operations

**State Management:**
- SwiftUI `@StateObject` for `AIAssistantViewModel`
- `@Published` properties for reactive UI updates
- ObservableObject pattern for service layer

**Async/Await:**
- All AI operations use `async throws` pattern
- No callback-based APIs
- `Task { }` for asynchronous work

**Existing Services:**
- Reuse `Logger.swift` for debugging
- Follow patterns from `MessageService.swift` and `ChatService.swift`

---

## 12. Testing Plan & Acceptance Gates

See `Psst/docs/testing-strategy.md` for detailed guidance.

---

### Happy Path

- [ ] Developer imports `AIService` into a ViewModel
- [ ] Calls `getMockResponse(for: "Hello AI")` 
- [ ] Receives mock `AIResponse` with text
- [ ] `AIAssistantView` displays user message + AI response
- **Gate:** Mock conversation appears in SwiftUI preview with proper formatting
- **Pass Criteria:** No console errors, messages display in correct bubbles (user = blue/right, AI = gray/left)

---

### Edge Cases

- [ ] **Edge Case 1: Empty Message**
  - **Test:** Call `sendMessage(message: "", conversationId: nil)`
  - **Expected:** Throws `AIError.invalidResponse` or validates before sending
  - **Pass:** Error handled gracefully, user sees validation message

- [ ] **Edge Case 2: Very Long Message (1000+ characters)**
  - **Test:** Send message with 1500 characters
  - **Expected:** Accepts without crash, formats in message bubble correctly
  - **Pass:** Message displays fully (scrollable if needed), no truncation bugs

- [ ] **Edge Case 3: Special Characters/Emojis**
  - **Test:** Send message: "What's ðŸ”¥ about AI? ðŸ¤–ðŸ’¬"
  - **Expected:** Encodes/decodes correctly, displays emojis
  - **Pass:** Message appears exactly as typed

---

### Error Handling

- [ ] **Not Authenticated**
  - **Test:** Call `AIService.sendMessage()` when user not logged in
  - **Expected:** Throws `AIError.notAuthenticated`
  - **Pass:** Clear error message: "You must be logged in to use AI features"

- [ ] **Mock Data Validation**
  - **Test:** Load mock conversation with invalid data (nil text, invalid timestamp)
  - **Expected:** App handles gracefully (skips invalid messages or uses defaults)
  - **Pass:** No crash, console shows warning but app continues

- [ ] **Codable Encoding/Decoding**
  - **Test:** Encode `AIMessage` to JSON, decode back
  - **Expected:** Data matches original (text, timestamp, isFromUser)
  - **Pass:** No data loss, fields match exactly

---

### Performance Check

- [ ] AIAssistantView loads in < 100ms
- [ ] SwiftUI preview renders without delay
- [ ] No UI blocking during mock response generation
- [ ] Smooth scrolling with 50+ mock messages (if testing large conversations)

---

## 13. Definition of Done

See standards in `Psst/agents/shared-standards.md`:

- [ ] All model files created with Codable conformance
- [ ] AIService implements required methods (stubbed for future use)
- [ ] AIAssistantViewModel manages conversation state
- [ ] AIAssistantView displays mock conversations
- [ ] SwiftUI previews work for all new views
- [ ] Mock data provides 3-5 realistic AI exchanges
- [ ] All acceptance gates pass
- [ ] Manual testing completed (navigation, display, edge cases)
- [ ] No console errors or warnings
- [ ] Code follows MVVM pattern
- [ ] Documentation comments on public APIs
- [ ] Async/await used consistently (no callback hell)

---

## 14. Risks & Mitigations

**Risk: Mock data doesn't match real backend structure**
- Mitigation: Review AI backend schema from PR #001, coordinate on data contracts
- Mitigation: Use JSON preview to validate Codable conformance early

**Risk: Service architecture doesn't scale to real AI features**
- Mitigation: Follow existing patterns from `MessageService` and `ChatService`
- Mitigation: Keep service layer thin, business logic in ViewModels

**Risk: Async operations block main thread**
- Mitigation: Use `@MainActor` properly, test with Instruments
- Mitigation: All service methods async, no blocking calls

**Risk: Future PRs need to refactor this scaffolding**
- Mitigation: Design for extension (protocol-based if needed)
- Mitigation: Document assumptions clearly in code comments

---

## 15. Rollout & Telemetry

**Feature Flag:** Not needed (developer-facing infrastructure)

**Metrics:**
- Development: Compile time, SwiftUI preview render time
- Manual validation: Does AI view appear in navigation? Do mock messages display?

**Validation Steps:**
1. Build project â†’ 0 compiler errors
2. Open AIAssistantView in preview â†’ renders successfully
3. Navigate to AI view in Simulator â†’ displays mock conversation
4. Check console â†’ 0 errors/warnings

---

## 16. Open Questions

**Q1:** Should AIConversation be stored in Firestore now or later?
- **Decision:** Later. For now, in-memory only. PR #003 (AI Chat Backend) will add persistence.

**Q2:** Should we reuse existing `MessageRow` component or create separate `AIMessageRow`?
- **Decision:** Create separate `AIMessageRow` for AI-specific styling (distinct from regular messages).

**Q3:** Should AIService be a singleton or instantiated per view?
- **Decision:** Follow existing pattern - shared instance via `@EnvironmentObject` or `@StateObject` in ViewModels.

**Q4:** How do we handle conversation history (pagination)?
- **Decision:** Defer to PR #003. For now, load all messages in memory (mock data is small).

---

## 17. Appendix: Out-of-Scope Backlog

Items deferred for future PRs:

- [ ] Real Cloud Function integration (PR #003)
- [ ] Firestore persistence for AI conversations (PR #003)
- [ ] Voice input/output (PR #010)
- [ ] Contextual AI actions in regular chats (PR #006)
- [ ] Function calling (schedule, remind) (PR #008)
- [ ] Proactive suggestions (PR #009)

---

## Preflight Questionnaire

1. **Smallest end-to-end user outcome for this PR?**
   - Developer can navigate to AI view and see mock AI conversation

2. **Primary user and critical action?**
   - iOS developers; import and use AIService

3. **Must-have vs nice-to-have?**
   - Must: Models, AIService, skeleton view
   - Nice: Polish, animations, advanced mock scenarios

4. **Real-time requirements?**
   - None for this PR (mock data only)

5. **Performance constraints?**
   - View load < 100ms
   - No blocking on main thread

6. **Error/edge cases to handle?**
   - Empty messages, long messages, Codable failures

7. **Data model changes?**
   - New models: AIMessage, AIConversation, AIResponse

8. **Service APIs required?**
   - AIService with stubbed async methods

9. **UI entry points and states?**
   - Entry: Navigation from chat list (placeholder)
   - States: Empty, loading, mock messages displayed

10. **Security/permissions implications?**
    - Verify user authentication before AI operations

11. **Dependencies or blocking integrations?**
    - None (parallel with PR #001)

12. **Rollout strategy and metrics?**
    - Immediate (developer-facing), validate via manual testing

13. **What is explicitly out of scope?**
    - Real AI functionality, Cloud Functions, Firestore persistence, voice interface

---

## Authoring Notes

- This PR is pure scaffolding - focus on structure and patterns
- Mock data should be realistic enough to guide future UI work
- Keep service layer generic to accommodate different AI backends
- Follow existing MVVM patterns from MessageService/ChatService
- Coordinate with PR #001 (backend) on data contracts
- All async operations use Swift async/await
- Reference `Psst/agents/shared-standards.md` for code quality standards

